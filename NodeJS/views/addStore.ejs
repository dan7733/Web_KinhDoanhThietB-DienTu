<div class="container">
    <div class="addstore-inforinput card p-4 shadow-sm">
        <h4 class="mb-3">
            <i class="fas fa-store text-primary"></i> Thêm cửa hàng
        </h4>

        <!-- Thông báo (nếu có) -->
        <% if (data && data.message) { %>
            <div class="alert alert-info">
                <%= data.message %>
            </div>
        <% } %>

        <form action="/addStore" method="POST" onsubmit="getCoordinates(event)">
            <!-- Tên cửa hàng -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-tag"></i> Tên cửa hàng</label>
                <input type="text" class="form-control" name="name" placeholder="Nhập tên cửa hàng" required>
            </div>

            <!-- Địa chỉ -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-map-marker-alt"></i> Địa chỉ</label>
                <input type="text" class="form-control" name="address" id="address" placeholder="Nhập địa chỉ cửa hàng" required>
            </div>

            <!-- Vĩ độ (Tự động cập nhật) -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-map"></i> Vĩ độ</label>
                <input type="text" class="form-control" name="latitude" id="latitude" placeholder="Đang lấy vĩ độ..." readonly required>
            </div>

            <!-- Kinh độ (Tự động cập nhật) -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-map"></i> Kinh độ</label>
                <input type="text" class="form-control" name="longitude" id="longitude" placeholder="Đang lấy kinh độ..." readonly required>
            </div>

            <!-- Hiển thị bản đồ -->
            <div id="map" class="mb-3" style="height: 400px; border-radius: 10px;"></div>

            <!-- Giờ mở cửa -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-clock"></i> Giờ mở cửa</label>
                <input type="text" class="form-control" name="open_hours" placeholder="Nhập giờ mở cửa (VD: 8:00)" required>
            </div>

            <!-- Giờ đóng cửa -->
            <div class="mb-3">
                <label class="form-label"><i class="fas fa-clock"></i> Giờ đóng cửa</label>
                <input type="text" class="form-control" name="close_hour" placeholder="Nhập giờ đóng cửa (VD: 22:00)" required>
            </div>

            <!-- Nút thêm -->
            <button type="submit" class="addstore-btn-add">
                <i class="fas fa-check"></i> Thêm cửa hàng
            </button>
        </form>
    </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    // Khởi tạo bản đồ Leaflet
    var map = L.map('map').setView([10.762622, 106.660172], 12); // Mặc định: TP HCM

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var marker;

    function getCoordinates(event) {
        event.preventDefault(); // Ngăn chặn form gửi ngay lập tức

        var address = document.getElementById("address").value;
        if (!address) {
            alert("Vui lòng nhập địa chỉ");
            return;
        }

        // Gửi request đến Nominatim để lấy tọa độ từ địa chỉ
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    var lat = parseFloat(data[0].lat);
                    var lon = parseFloat(data[0].lon);

                    document.getElementById("latitude").value = lat;
                    document.getElementById("longitude").value = lon;

                    // Cập nhật bản đồ và marker
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([lat, lon]).addTo(map)
                        .bindPopup("Vị trí cửa hàng").openPopup();

                    map.setView([lat, lon], 14);

                    // Gửi form sau khi cập nhật tọa độ
                    document.querySelector("form").submit();
                } else {
                    alert("Không tìm thấy tọa độ cho địa chỉ này.");
                }
            })
            .catch(error => console.error("Lỗi khi lấy tọa độ:", error));
    }
</script>
