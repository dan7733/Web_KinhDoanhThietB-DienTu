<div class="container py-5">
    <div class="updateorder-card card shadow-lg p-4">
        <h4 class="card-title mb-4 text-primary">
            <i class="fas fa-edit me-2"></i> Cập nhật trạng thái đơn hàng
        </h4>

        <% if (data && data.message) { %>
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <%= data.message %>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <% } %>

        <form action="/updateorder" method="POST">
            <input type="hidden" name="order_id" value="<%= data.order ? data.order.order_id : '' %>">

            <!-- Order Information -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Thông tin đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-user me-2"></i>Tên khách hàng</label>
                            <p class="form-control-plaintext"><%= data.order && data.order.User ? data.order.User.fullname : 'N/A' %></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-dollar-sign me-2"></i>Tổng giá</label>
                            <p class="form-control-plaintext"><%= data.order ? data.order.total_price.toFixed(2) : '0.00' %> VND</p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-map-marker-alt me-2"></i>Địa chỉ</label>
                            <p class="form-control-plaintext"><%= data.order ? data.order.address : 'N/A' %></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-phone me-2"></i>Số điện thoại</label>
                            <p class="form-control-plaintext"><%= data.order ? data.order.phone : 'N/A' %></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-envelope me-2"></i>Email</label>
                            <p class="form-control-plaintext"><%= data.order && data.order.email ? data.order.email : 'N/A' %></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-note-sticky me-2"></i>Ghi chú</label>
                            <p class="form-control-plaintext"><%= data.order && data.order.note ? data.order.note : 'Không có' %></p>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold"><i class="fas fa-credit-card me-2"></i>Trạng thái thanh toán</label>
                            <p class="form-control-plaintext">
                                <%= data.order && data.order.status_payment ? 
                                    (data.order.status_payment === 'waiting_payment' ? 'Đang chờ thanh toán' :
                                     data.order.status_payment === 'paid' ? 'Đã thanh toán' :
                                     data.order.status_payment === 'failed' ? 'Thanh toán thất bại' : 'N/A') 
                                    : 'N/A' %>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Status Update -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Cập nhật trạng thái</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-info-circle me-2"></i>Trạng thái đơn hàng</label>
                        <select class="form-select" name="status" required>
                            <option value="pending" <%= data.order && data.order.status === 'pending' ? 'selected' : '' %>>Đang chờ</option>
                            <option value="confirmed" <%= data.order && data.order.status === 'confirmed' ? 'selected' : '' %>>Đã xác nhận</option>
                            <option value="shipped" <%= data.order && data.order.status === 'shipped' ? 'selected' : '' %>>Đang giao</option>
                            <option value="delivered" <%= data.order && data.order.status === 'delivered' ? 'selected' : '' %>>Đã giao</option>
                            <option value="cancelled" <%= data.order && data.order.status === 'cancelled' ? 'selected' : '' %>>Đã hủy</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-credit-card me-2"></i>Trạng thái thanh toán</label>
                        <select class="form-select" name="status_payment" required>
                            <option value="waiting_payment" <%= data.order && data.order.status_payment === 'waiting_payment' ? 'selected' : '' %>>Đang chờ thanh toán</option>
                            <option value="paid" <%= data.order && data.order.status_payment === 'paid' ? 'selected' : '' %>>Đã thanh toán</option>
                            <option value="failed" <%= data.order && data.order.status_payment === 'failed' ? 'selected' : '' %>>Thanh toán thất bại</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Order Details -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Chi tiết đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-primary">
                                <tr>
                                    <th scope="col">Ảnh sản phẩm</th>
                                    <th scope="col">Sản phẩm</th>
                                    <th scope="col">Số lượng</th>
                                    <th scope="col">Giá</th>
                                    <th scope="col">Giá giảm</th>
                                    <th scope="col">Tổng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% if (data.orderDetails && data.orderDetails.length > 0) { %>
                                    <% data.orderDetails.forEach(function(detail) { %>
                                        <tr>
                                            <td>
                                                <img src="<%= detail.Product && detail.Product.product_img ? '/images/products/' + detail.Product.product_img : '/images/placeholder.jpg' %>" 
                                                alt="Product Image" class="product-image" style="max-width: 60px; border-radius: 4px;">                                           
                                            </td>
                                            <td><%= detail.Product && detail.Product.name ? detail.Product.name : detail.product_id %></td>
                                            <td><%= detail.quantity %></td>
                                            <td><%= detail.price.toFixed(2) %> VND</td>
                                            <td><%= detail.discount_price ? detail.discount_price.toFixed(2) : '0.00' %> VND</td>
                                            <td><%= ((detail.discount_price || detail.price) * detail.quantity).toFixed(2) %> VND</td>
                                        </tr>
                                    <% }); %>
                                <% } else { %>
                                    <tr>
                                        <td colspan="6" class="text-center">Không có chi tiết đơn hàng.</td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="text-end">
                <button type="submit" class="btn btn-primary btn-updateorder">
                    <i class="fas fa-save me-2"></i>Cập nhật trạng thái
                </button>
                <a href="/downloadOrderPDF/<%= data.order ? data.order.order_id : '' %>" class="btn btn-secondary btn-download-pdf">
                    <i class="fas fa-file-pdf me-2"></i>Tải xuống PDF
                </a>
            </div>
        </form>
    </div>
</div>