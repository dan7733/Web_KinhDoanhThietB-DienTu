<div class="container">
    <div class="updateproduct-inforinput card p-4 shadow-sm mt-5">
        <h4 class="mb-3">
            <i class="fas fa-edit text-primary"></i> Cập nhật sản phẩm
        </h4>

        <% if (data && data.message) { %>
            <div class="alert alert-info">
                <%= data.message %>
            </div>
        <% } %>

        <form action="/updateproduct" method="POST" enctype="multipart/form-data">
            <input type="hidden" name="product_id" value="<%= data.product ? data.product.product_id : '' %>">

            <div class="mb-3">
                <label class="form-label"><i class="fas fa-tag"></i> Tên sản phẩm</label>
                <input type="text" class="form-control" name="name" 
                       value="<%= data.product ? data.product.name : '' %>" required>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="fas fa-dollar-sign"></i> Giá</label>
                <input type="number" class="form-control" name="price" 
                       value="<%= data.product ? data.product.price : '' %>" required>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="fas fa-percent"></i> Giá giảm (nếu có)</label>
                <input type="number" class="form-control" name="discount_price" 
                       value="<%= data.product ? data.product.discount_price : '' %>">
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="fas fa-list"></i> Mô tả sản phẩm</label>
                <textarea id="product_description" name="description"><%= data.product ? data.product.description : '' %></textarea>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="fas fa-image"></i> Ảnh sản phẩm</label>
                <div class="updateproduct-upload-box" id="updateproduct_drop_area">
                    <% if (data.product && data.product.product_img) { %>
                        <input type="hidden" name="oldImage" value="<%= data.product.product_img %>">
                    <% } %>  
                    
                    <input type="file" name="product_image" id="updateproduct_image_input" accept="image/*" hidden>
                    <div id="updateproduct_click_area" style="cursor: pointer;">
                        <i class="fas fa-cloud-upload-alt fa-2x"></i>
                        <p>Kéo & thả hoặc nhấn để tải lên</p>
                    </div>
                    
                    <div class="updateproduct-preview-container" id="updateproduct_preview_container" 
                         <%= data.product && data.product.product_img ? '' : 'hidden' %>>
                        <img id="updateproduct_image_preview" class="img-thumbnail mt-2"
                             src="<%= data.product && data.product.product_img ? '/images/products/' + data.product.product_img : '' %>" 
                             alt="Ảnh sản phẩm">
                        <button type="button" class="btn btn-danger" id="updateproduct_remove_image">Xóa</button>
                    </div>
                </div>
                <span class="updateproduct-file-name" id="updateproduct_file_name"></span>
            </div>
            

            <div class="mb-3">
                <label class="form-label"><i class="fas fa-building"></i> Thương hiệu</label>
                <% if (data.brands && data.brands.length > 0) { %>
                    <select class="form-control" name="brand_id">
                        <option value="">Chọn thương hiệu</option>
                        <% data.brands.forEach(function(brand) { %>
                            <option value="<%= brand.brand_id %>" <%= data.product && data.product.brand_id == brand.brand_id ? 'selected' : '' %>><%= brand.name %></option>
                        <% }); %>
                    </select>
                <% } else { %>
                    <p class="text-danger">Không có thương hiệu nào.</p>
                <% } %>
            </div>

            <div class="mb-3">
                <label class="form-label"><i class="fas fa-layer-group"></i> Danh mục</label>
                <% if (data.categories && data.categories.length > 0) { %>
                    <select class="form-control" name="category_id" required>
                        <option value="">Chọn danh mục</option>
                        <% data.categories.forEach(function(category) { %>
                            <option value="<%= category.category_id %>" <%= data.product && data.product.category_id == category.category_id ? 'selected' : '' %>><%= category.name %></option>
                        <% }); %>
                    </select>
                <% } else { %>
                    <p class="text-danger">Không có danh mục nào.</p>
                <% } %>
            </div>

            <button type="submit" class="btn updateproduct-btn-update">
                <i class="fas fa-save"></i> Cập nhật sản phẩm
            </button>
        </form>
    </div>
</div>

<script>
    CKEDITOR.replace('product_description');

    document.addEventListener("DOMContentLoaded", function () {
        let imgInput = document.getElementById("updateproduct_image_input");
        let clickArea = document.getElementById("updateproduct_click_area");
        let dropArea = document.getElementById("updateproduct_drop_area");
        let fileNameSpan = document.getElementById("updateproduct_file_name");
        let imgPreview = document.getElementById("updateproduct_image_preview");
        let previewContainer = document.getElementById("updateproduct_preview_container");
        let removeImageButton = document.getElementById("updateproduct_remove_image");

        clickArea.addEventListener("click", function () {
            imgInput.click();
        });

        imgInput.addEventListener("change", function (event) {
            let file = event.target.files[0];
            if (file) {
                fileNameSpan.textContent = file.name;
                let reader = new FileReader();
                reader.onload = function (e) {
                    imgPreview.src = e.target.result;
                    previewContainer.style.display = "flex";
                };
                reader.readAsDataURL(file);
            }
        });

        dropArea.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropArea.classList.add("highlight");
        });

        dropArea.addEventListener("dragleave", () => {
            dropArea.classList.remove("highlight");
        });

        dropArea.addEventListener("drop", (e) => {
            e.preventDefault();
            dropArea.classList.remove("highlight");

            let file = e.dataTransfer.files[0];
            if (file) {
                imgInput.files = e.dataTransfer.files;
                fileNameSpan.textContent = file.name;
                let reader = new FileReader();
                reader.onload = function (e) {
                    imgPreview.src = e.target.result;
                    previewContainer.style.display = "flex";
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageButton.addEventListener("click", function () {
            imgInput.value = "";
            imgPreview.src = "";
            previewContainer.style.display = "none";
            fileNameSpan.textContent = "";
        });
    });
</script>
